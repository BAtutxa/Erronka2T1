<app-menu></app-menu>

<ion-content [fullscreen]="true">
  <div class="search-container">
    <ion-searchbar
      placeholder="Buscar en {{ currentSection === 'productos' ? 'productos' : 'materiales' }}"
      (ionInput)="filterItems($event)"
    ></ion-searchbar>

    <ion-button class="add-group-btn" shape="round" (click)="toggleForm()">
      <ion-icon name="add-circle-outline"></ion-icon>
    </ion-button>
    <ion-button *ngIf="isAdmin" [routerLink]="'/graficos'">Gráficos</ion-button>


  </div>

  <div class="toggle-container">
    <ion-segment [(ngModel)]="currentSection" (ionChange)="segmentChanged()">
      <ion-segment-button value="productos">Productos</ion-segment-button>
      <ion-segment-button value="materiales">Materiales</ion-segment-button>
    </ion-segment>
  </div>

  <div class="item-grid">
    <ng-container *ngIf="filteredItems.length; else noItems">
      <ion-card
        class="item-card"
        *ngFor="let item of filteredItems"
        (click)="showItemDetails(item)"
      >
        <ion-card-header>
          <ion-card-title>{{ item.name }}</ion-card-title>
        </ion-card-header>
        <ion-button 
          fill="clear"
          (click)="deleteItem(item.id, $event)"
        >
          <ion-icon name="trash"></ion-icon>
        </ion-button> 

        <ion-button fill="clear" (click)="openDocumentModal(item, $event)">
          <ion-icon name="document"></ion-icon>
        </ion-button>
      </ion-card>
    </ng-container>
    <ng-template #noItems>
      <p class="no-items">No hay {{ currentSection }} disponibles.</p>
    </ng-template>
  </div>

  <!-- MODAL PARA EDITAR DETALLES DEL PRODUCTO -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeItemDetails()">
    <ng-container *ngIf="selectedItem">
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ selectedItem.name }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeItemDetails()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
  
      <ion-content>
        <div class="item-details">
          <ng-container *ngIf="selectedItem.type === 'producto'">
            <ion-item>
              <ion-label position="stacked">Nombre</ion-label>
              <ion-input [(ngModel)]="selectedItem.name"></ion-input>
            </ion-item>  
            <ion-item>
              <ion-label position="stacked">Descripción</ion-label>
              <ion-textarea [(ngModel)]="selectedItem.description"></ion-textarea>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Categoría</ion-label>
              <ion-input [value]="selectedItem.kategoria?.izena || 'Sin categoría'"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Marca</ion-label>
              <ion-input [(ngModel)]="selectedItem.marka"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Stock</ion-label>
              <ion-input type="number" [(ngModel)]="selectedItem.stock" disabled></ion-input>
            </ion-item>

            <!-- NUEVO: Campo para restar stock -->
            <ion-item>
              <ion-label position="stacked">Cantidad a Restar</ion-label>
              <ion-input type="number" [(ngModel)]="cantidadRestar"></ion-input>
            </ion-item>

            <ion-button expand="full" color="danger" (click)="restarStock()">Restar del Stock</ion-button>
          </ng-container>

          <ng-container *ngIf="selectedItem.type === 'material'">
            <ion-item>
              <ion-label position="stacked">Nombre</ion-label>
              <ion-input [(ngModel)]="selectedItem.name"></ion-input>
            </ion-item>
            <ion-item>
              <ion-label position="stacked">Etiqueta</ion-label>
              <ion-input [(ngModel)]="selectedItem.description"></ion-input>
            </ion-item>
          </ng-container>
  
          <ion-button expand="full" (click)="saveChanges()">Guardar Cambios</ion-button>
        </div>
      </ion-content>
    </ng-container>
  </ion-modal>
</ion-content>
